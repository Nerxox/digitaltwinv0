<!doctype html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Digital Twin{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
      :root{
        --dt-primary:#1e40af; /* deep blue */
        --dt-primary-600:#1d4ed8; /* button blue */
        --dt-primary-100:#e8f0ff; /* light bg */
        --dt-border:#dfe6f3;
      }
      .navbar{ background: linear-gradient(90deg, var(--dt-primary), var(--dt-primary-600)); }
      .section-card{ border:1px solid var(--dt-border); box-shadow: 0 1px 2px rgba(0,0,0,.04); }
      .section-title{ background: var(--dt-primary-100); border-bottom:1px solid var(--dt-border); }
      .badge-soft{ background: var(--dt-primary-100); color: var(--dt-primary); }
    </style>
  </head>
  <body class="bg-body-tertiary" hx-boost="true">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid container-xxl py-2">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
          <span class="btn btn-light btn-sm fw-bold rounded-circle d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px">DT</span>
          <span class="fw-semibold">Digital Twin</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topnav"><span class="navbar-toggler-icon"></span></button>
        <div id="topnav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/" hx-get="/" hx-target="#app" hx-push-url="true"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/stations3d/" hx-get="/stations3d/" hx-target="#app" hx-push-url="true"><i class="bi bi-cube me-1"></i>3D Stations</a></li>
            <li class="nav-item"><a class="nav-link" href="/anomalies/" hx-get="/anomalies/" hx-target="#app" hx-push-url="true"><i class="bi bi-exclamation-octagon me-1"></i>Anomalies</a></li>
            <li class="nav-item"><a class="nav-link" href="/predict/" hx-get="/predict/" hx-target="#app" hx-push-url="true"><i class="bi bi-graph-up-arrow me-1"></i>Predictions</a></li>
            <li class="nav-item"><a class="nav-link" href="/compare/" hx-get="/compare/" hx-target="#app" hx-push-url="true"><i class="bi bi-sliders me-1"></i>Compare Models</a></li>
            <li class="nav-item"><a class="nav-link" href="/maintenance/" hx-get="/maintenance/" hx-target="#app" hx-push-url="true"><i class="bi bi-tools me-1"></i>Maintenance</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main id="app" class="container-xxl my-4" hx-indicator="#hx-loading">
      {% block content %}{% endblock %}
    </main>

    <div id="hx-loading" class="position-fixed" style="right:1rem; bottom:1rem; z-index:1080; display:none;">
      <div class="spinner-border text-primary" role="status" style="width:2rem; height:2rem;"><span class="visually-hidden">Loading...</span></div>
    </div>

    <footer class="border-top py-4 bg-white">
      <div class="container-xxl small text-secondary d-flex justify-content-between">
        <span>  {{ now|date:'Y' }} Digital Twin</span>
        <span>Built with Django Â· Bootstrap 5</span>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script>
      document.addEventListener('htmx:configRequest', (evt)=>{
        evt.detail.headers['X-Request-ID'] = (crypto?.randomUUID?.()||Math.random().toString(36).slice(2));
      });
      const showL=()=>{ const el=document.getElementById('hx-loading'); if(el) el.style.display='block'; };
      const hideL=()=>{ const el=document.getElementById('hx-loading'); if(el) el.style.display='none'; };
      document.addEventListener('htmx:request', showL);
      document.addEventListener('htmx:afterOnLoad', hideL);
      document.addEventListener('htmx:responseError', (e)=>{
        hideL();
        // Fallback to full navigation on error so links always work
        try {
          const url = e.detail?.pathInfo?.requestPath || e.detail?.xhr?.responseURL;
          if (url) window.location.href = url;
        } catch(_){}
      });
      document.addEventListener('htmx:sendError', (e)=>{ hideL(); try{ const u=e.detail?.pathInfo?.requestPath; if(u) window.location.href=u; }catch(_){} });
      document.addEventListener('htmx:timeout', (e)=>{ hideL(); try{ const u=e.detail?.pathInfo?.requestPath; if(u) window.location.href=u; }catch(_){} });

      function execScripts(container){
        if(!container) return;
        const scripts = container.querySelectorAll('script');
        scripts.forEach((s)=>{
          // Skip JSON script tags used by Django's json_script
          if (s.type && s.type.includes('json')) return;
          if (s.src) {
            // Prevent re-inserting the same external script
            if (s.dataset.once === 'true' || s.getAttribute('data-once') === 'true') {
              const already = Array.from(document.scripts).some(x => x.src === s.src);
              if (already) return;
            }
            const el = document.createElement('script');
            el.src = s.src; el.type = s.type || 'text/javascript';
            if (s.dataset.once === 'true' || s.getAttribute('data-once') === 'true') el.setAttribute('data-once','true');
            document.head.appendChild(el);
          } else if ((s.type||'').toLowerCase() === 'module') {
            // Re-insert module scripts to trigger execution
            const el = document.createElement('script');
            el.type = 'module';
            el.textContent = s.textContent;
            document.head.appendChild(el);
          } else {
            // Skip inline scripts marked data-once if we've executed them before
            if (s.dataset.once === 'true' || s.getAttribute('data-once') === 'true') {
              if (s.__executedOnce) return;
              s.__executedOnce = true;
            }
            try { (0, eval)(s.textContent); } catch(e) { console.warn('Inline script error', e); }
          }
        });
      }

      document.addEventListener('htmx:afterSwap', (e)=>{
        // Re-execute scripts inside swapped containers so charts & 3D initialize
        const tgt = e.detail?.target;
        if (!tgt) return;
        if (tgt.id === 'app' || tgt.id === 'detailModalBody') {
          // slight delay to allow DOM paint
          setTimeout(()=>execScripts(tgt), 0);
        }
      });
    </script>
  </body>
</html>
  {% now "U" as __ignored %}
