{% extends "base.html" %}
{% block title %}Anomalies{% endblock %}
{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h4 m-0"><i class="bi bi-exclamation-octagon me-2"></i>Anomalies</h2>
    <span class="badge badge-soft"><i class="bi bi-link-45deg me-1"></i>{{ api_base }}</span>
  </div>

  {% if errors and errors|length %}
    <div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>Some data could not be loaded:
      <ul class="mb-0 mt-2">
        {% for e in errors %}<li class="small">{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="card section-card mb-3">
    <div class="card-header section-title d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center"><i class="bi bi-activity me-2 text-primary"></i><span class="fw-semibold">Anomaly Table</span></div>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Severity filter">
          <button class="btn btn-outline-secondary active" data-filter="all">All</button>
          <button class="btn btn-outline-success" data-filter="None">Normal</button>
          <button class="btn btn-outline-warning" data-filter="Medium">Medium</button>
          <button class="btn btn-outline-danger" data-filter="High">High</button>
        </div>
        <a class="btn btn-sm btn-primary" href="#" hx-get="/anomalies/upload/" hx-target="#app" hx-boost="false"><i class="bi bi-upload me-1"></i>Upload Data</a>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="anomTable" class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Machine</th>
              <th>Severity</th>
              <th>Drift Horizons</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr data-sev="{{ row.severity }}">
              <td class="fw-semibold">{{ row.machine_id }}</td>
              <td>
                {% if row.severity == 'High' %}
                  <span class="badge text-bg-danger">High</span>
                {% elif row.severity == 'Medium' %}
                  <span class="badge text-bg-warning">Medium</span>
                {% elif row.severity == 'None' %}
                  <span class="badge text-bg-success">None</span>
                {% else %}
                  <span class="badge text-bg-secondary">Unknown</span>
                {% endif %}
              </td>
              <td>
                {% if row.drifts and row.drifts|length %}
                  {% for h in row.drifts %}<span class="badge text-bg-primary me-1">{{ h }}m</span>{% endfor %}
                {% else %}
                  <span class="text-secondary">—</span>
                {% endif %}
              </td>
              <td>
                <a
                  href="javascript:void(0)"
                  hx-get="/anomalies/{{ row.machine_id }}/?_partial=1"
                  hx-target="#detailModalBody"
                  hx-swap="innerHTML"
                  hx-push-url="false"
                  hx-boost="false"
                  class="text-decoration-none"
                  data-bs-toggle="modal"
                  data-bs-target="#detailModal"
                ><i class="bi bi-eye me-1"></i>Details</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card section-card">
    <div class="card-header section-title d-flex align-items-center"><i class="bi bi-badge-3d me-2 text-primary"></i><span class="fw-semibold">3D Digital Twin</span></div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <canvas id="twincanvas" style="width:100%; height:420px; background:#eef4ff; border:1px solid var(--dt-border);"></canvas>
          <div class="small text-secondary mt-2">Drag to rotate · Scroll to zoom · Click a machine to open details</div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="small text-secondary mb-2">Legend</div>
          <div class="d-flex align-items-center gap-2 mb-1"><span class="badge" style="background:#22c55e">Normal</span><span class="small">No anomaly</span></div>
          <div class="d-flex align-items-center gap-2 mb-1"><span class="badge" style="background:#f59e0b">Medium</span><span class="small">Some drift</span></div>
          <div class="d-flex align-items-center gap-2"><span class="badge" style="background:#ef4444">High</span><span class="small">Significant drift</span></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js" data-once="true"></script>
  <script>
    // Inline OrbitControls (no module import) for speed
    function OrbitControls(object, domElement){
      this.object=object; this.domElement=domElement; this.enabled=true; this.target=new THREE.Vector3(0,0,0);
      this.minDistance=2; this.maxDistance=60; this.enableDamping=true; this.dampingFactor=.08; this.rotateSpeed=.4; this.zoomSpeed=1; this.panSpeed=.4; this.maxPolarAngle=Math.PI*0.49;
      const scope=this,STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2}; let state=STATE.NONE; const sph=new THREE.Spherical(),dSph=new THREE.Spherical(); let scale=1,panOff=new THREE.Vector3();
      const rS=new THREE.Vector2(),rE=new THREE.Vector2(),rD=new THREE.Vector2(),pS=new THREE.Vector2(),pE=new THREE.Vector2(),pD=new THREE.Vector2(),dS=new THREE.Vector2(),dE=new THREE.Vector2(),dD=new THREE.Vector2();
      this.update=function(){ const off=new THREE.Vector3(); off.copy(scope.object.position).sub(scope.target); sph.setFromVector3(off); sph.theta+=dSph.theta*scope.dampingFactor; sph.phi+=dSph.phi*scope.dampingFactor; sph.phi=Math.max(0,Math.min(scope.maxPolarAngle,sph.phi)); sph.makeSafe(); sph.radius*=scale; sph.radius=Math.max(scope.minDistance,Math.min(scope.maxDistance,sph.radius)); scope.target.addScaledVector(panOff,scope.dampingFactor); off.setFromSpherical(sph); off.add(scope.target); scope.object.position.copy(off); scope.object.lookAt(scope.target); dSph.theta*=(1-scope.dampingFactor); dSph.phi*=(1-scope.dampingFactor); panOff.multiplyScalar(1-scope.dampingFactor); scale=1; };
      function pan(dx,dy){ const el=scope.domElement; const off=new THREE.Vector3(); off.copy(scope.object.position).sub(scope.target); const dist=off.length()*Math.tan((scope.object.fov/2)*Math.PI/180); const panX=2*dx*dist/el.clientHeight, panY=2*dy*dist/el.clientHeight; const xAx=new THREE.Vector3().setFromMatrixColumn(scope.object.matrix,0).multiplyScalar(-panX); const yAx=new THREE.Vector3().setFromMatrixColumn(scope.object.matrix,1).multiplyScalar(panY); panOff.add(xAx).add(yAx); }
      function dollyIn(){scale/=1.1;} function dollyOut(){scale*=1.1;}
      function onDown(e){ if(!scope.enabled)return; if(e.button===0){rS.set(e.clientX,e.clientY);state=STATE.ROTATE;} if(e.button===1){dS.set(e.clientX,e.clientY);state=STATE.DOLLY;} if(e.button===2){pS.set(e.clientX,e.clientY);state=STATE.PAN;} domElement.addEventListener('mousemove',onMove);domElement.addEventListener('mouseup',onUp); }
      function onMove(e){ if(!scope.enabled)return; if(state===STATE.ROTATE){ rE.set(e.clientX,e.clientY); rD.subVectors(rE,rS).multiplyScalar(scope.rotateSpeed*0.005); dSph.theta-=rD.x; dSph.phi-=rD.y; rS.copy(rE);} if(state===STATE.DOLLY){ dE.set(e.clientX,e.clientY); dD.subVectors(dE,dS); (dD.y>0?dollyIn():dollyOut()); dS.copy(dE);} if(state===STATE.PAN){ pE.set(e.clientX,e.clientY); pD.subVectors(pE,pS).multiplyScalar(scope.panSpeed*0.002); pan(pD.x,pD.y); pS.copy(pE);} }
      function onUp(){ domElement.removeEventListener('mousemove',onMove); domElement.removeEventListener('mouseup',onUp); state=STATE.NONE; }
      function onWheel(e){ (e.deltaY<0?dollyOut():dollyIn()); }
      domElement.addEventListener('mousedown',onDown); domElement.addEventListener('wheel',onWheel,{passive:true}); domElement.addEventListener('contextmenu', e=>e.preventDefault());
    }

    // 3D scene with cubes and interactions
    const rows = JSON.parse(document.getElementById('rows_data').textContent);
    const canvas = document.getElementById('twincanvas');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    function resizeCanvas(){ const rect = canvas.getBoundingClientRect(); renderer.setSize(rect.width, rect.height, false); camera.aspect = rect.width/rect.height; camera.updateProjectionMatrix(); }
    const rect = canvas.getBoundingClientRect();
    renderer.setSize(rect.width, rect.height, false);
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeef4ff);
    const camera = new THREE.PerspectiveCamera(50, rect.width/rect.height, 0.1, 100);
    camera.position.set(6,5,7);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0,0,0);

    const light = new THREE.DirectionalLight(0xffffff, 1.0); light.position.set(5,10,7); scene.add(light);
    const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);

    const g = new THREE.PlaneGeometry(12,8); const m = new THREE.MeshLambertMaterial({color:0xffffff});
    const ground = new THREE.Mesh(g,m); ground.rotation.x = -Math.PI/2; ground.position.y=-0.51; scene.add(ground);

    const positions = [ [-4,0], [-2,0], [0,0], [2,0], [4,0], [-4,2], [-2,2], [0,2], [2,2], [4,2] ];
    function colorFor(sev){
      if(sev==='High') return 0xef4444;
      if(sev==='Medium') return 0xf59e0b;
      if(sev==='None') return 0x22c55e;
      return 0x9ca3af;
    }
    const objects = [];
    const boxGeo = new THREE.BoxGeometry(1,1,1);
    if (rows.length === 0) {
      // placeholder grid
      for (let i=0;i<6;i++){
        const cube = new THREE.Mesh(boxGeo, new THREE.MeshLambertMaterial({color:0x9ca3af}));
        const [x,z] = positions[i]; cube.position.set(x,0,z); scene.add(cube);
      }
    } else {
      rows.slice(0, positions.length).forEach((row, idx)=>{
        const mat = new THREE.MeshLambertMaterial({color: colorFor(row.severity)});
        const cube = new THREE.Mesh(boxGeo, mat);
        const [x,z] = positions[idx];
        cube.position.set(x,0,z);
        cube.userData = { machine_id: row.machine_id, severity: row.severity };
        scene.add(cube); objects.push(cube);
        // simple label
        const spriteCanvas = document.createElement('canvas'); spriteCanvas.width=128; spriteCanvas.height=32;
        const ctx = spriteCanvas.getContext('2d'); ctx.fillStyle = '#0f172a'; ctx.font='16px Arial'; ctx.fillText(row.machine_id, 8, 20);
        const tex = new THREE.CanvasTexture(spriteCanvas);
        const smat = new THREE.SpriteMaterial({map: tex}); const spr = new THREE.Sprite(smat); spr.scale.set(1.6,0.4,1); spr.position.set(x,0.9,z);
        scene.add(spr);
      });
    }

    const ray = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    canvas.addEventListener('click', (ev)=>{
      const r = canvas.getBoundingClientRect();
      mouse.x = ((ev.clientX - r.left)/r.width)*2 - 1;
      mouse.y = -((ev.clientY - r.top)/r.height)*2 + 1;
      ray.setFromCamera(mouse, camera);
      const hit = ray.intersectObjects(objects, false);
      if (hit && hit.length){
        const mid = hit[0].object.userData.machine_id;
        if(mid){
          htmx.ajax('GET', `/anomalies/${mid}/?_partial=1`, { target: '#detailModalBody', swap: 'innerHTML', pushUrl: false });
          const modalEl = document.getElementById('detailModal');
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        }
      }
    });

    window.addEventListener('resize', resizeCanvas);

    function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();
    // Table severity filter
    const btns = document.querySelectorAll('[data-filter]');
    const tbody = document.querySelector('#anomTable tbody');
    btns.forEach(b=>b.addEventListener('click',()=>{
      btns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const sev = b.getAttribute('data-filter');
      tbody.querySelectorAll('tr').forEach(tr=>{
        const s = tr.getAttribute('data-sev');
        tr.style.display = (sev==='all' || s===sev) ? '' : 'none';
      });
    }));
  </script>
  {{ rows|json_script:"rows_data" }}

  <!-- Details Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Machine Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="detailModalBody" class="modal-body">
          <div class="text-center text-secondary py-5">Loading…</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
