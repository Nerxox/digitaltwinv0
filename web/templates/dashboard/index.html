{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="h4 m-0"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
    <span class="badge badge-soft"><i class="bi bi-link-45deg me-1"></i>{{ api_base }}</span>
  </div>

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="bi bi-layout-text-sidebar-reverse me-1"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#forecast" type="button" role="tab">
        <i class="bi bi-graph-up-arrow me-1"></i>Forecast
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <div id="overview" class="tab-pane fade show active">
      <div class="row g-3">
        <div class="col-12 col-lg-3">
          <div class="card section-card h-100"><div class="card-body">
            <div class="small text-secondary">Backend</div>
            <div class="h4 mb-1">{{ api_base }}</div>
            <div class="small text-secondary">Health: {% if health and health.status %}<span class="badge text-bg-success">OK</span>{% else %}<span class="badge text-bg-warning">Unknown</span>{% endif %}</div>
          </div></div>
        </div>
        <div class="col-12 col-lg-9">
          <div class="card section-card h-100">
            <div class="card-header section-title d-flex align-items-center"><i class="bi bi-graph-up me-2 text-primary"></i><span class="fw-semibold">Forecast (sample)</span></div>
            <div class="card-body">
              <canvas id="idx_chart" height="150"></canvas>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                (function(){
                  const pts = JSON.parse(document.getElementById('idx_points').textContent||'[]');
                  if(!pts.length) return;
                  const labels = pts.map(p=> (p.h||p.horizon_min)+"m");
                  const y = pts.map(p=> p.y);
                  const ctx = document.getElementById('idx_chart');
                  new Chart(ctx, { type:'line', data:{ labels, datasets:[
                    { label:'yhat', data:y, borderColor:'#1d4ed8', backgroundColor:'rgba(29,78,216,0.12)', fill:true, tension:0.35 }
                  ]}, options:{ responsive:true } });
                })();
              </script>
              {{ chart_points|json_script:"idx_points" }}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="overview" class="tab-pane fade show active" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="card section-card">
            <div class="card-header section-title d-flex align-items-center">
              <i class="bi bi-activity me-2 text-primary"></i>
              <span class="fw-semibold">Health</span>
            </div>
            <div class="card-body">
              {% if health %}
                <pre class="small bg-body-tertiary p-3 rounded border">{{ health|json_script:"health" }}</pre>
                <script>document.currentScript.previousElementSibling.textContent = JSON.stringify(JSON.parse(document.getElementById('health').textContent), null, 2)</script>
              {% else %}
                <div class="alert alert-light border">No health data.</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card section-card">
            <div class="card-header section-title d-flex align-items-center">
              <i class="bi bi-cpu me-2 text-primary"></i>
              <span class="fw-semibold">Model Info</span>
            </div>
            <div class="card-body">
              {% if model_info %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <tbody>
                      {% for k, v in model_info.items %}
                        <tr>
                          <th class="text-secondary" style="width:35%">{{ k|capfirst }}</th>
                          <td>{{ v }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="alert alert-light border">No model information available.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if errors %}
        <div class="alert alert-warning mt-3" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Issues:</strong>
          <ul class="mb-0 mt-2">
            {% for e in errors %}<li class="small">{{ e }}</li>{% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>

    <div id="forecast" class="tab-pane fade" role="tabpanel">
      {% if chart_points %}
        <div class="card section-card">
          <div class="card-header section-title d-flex align-items-center">
            <i class="bi bi-graph-up me-2 text-primary"></i>
            <span class="fw-semibold">Sample Forecast (M001)</span>
          </div>
          <div class="card-body">
            <canvas id="chart" height="120"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              (function(){
                const pts = JSON.parse(document.getElementById('chart_data').textContent);
                const labels = pts.map(p => p.h + 'm');
                const values = pts.map(p => p.y);
                const ctx = document.getElementById('chart');
                new Chart(ctx, {
                  type: 'line',
                  data: { labels, datasets: [{ label: 'yhat', data: values, borderColor: '#1d4ed8', backgroundColor: 'rgba(29,78,216,0.12)', tension: 0.35, fill: true, pointRadius: 3 }] },
                  options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
                });
              })();
            </script>
            {{ chart_points|json_script:"chart_data" }}
          </div>
        </div>
      {% else %}
        <div class="alert alert-info d-flex align-items-start" role="alert">
          <i class="bi bi-info-circle me-2 mt-1"></i>
          <div>
            <div class="fw-semibold">No forecast data available.</div>
            <div class="small">Ensure FastAPI is running at <code>{{ api_base }}</code> and the <code>/api/v1/predict</code> endpoint returns points. Then refresh this page.</div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-3 d-flex justify-content-end">
    <a href="/predict/" class="btn btn-primary"><i class="bi bi-graph-up-arrow me-1"></i>Go to Predictions</a>
  </div>

{% endblock %}
